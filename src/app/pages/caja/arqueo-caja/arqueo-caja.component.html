<div class="contenedor-flex">
  <div class="contenedor-formulario">
    <h4>Arqueo de Caja</h4>

    <mat-tab-group>
      <!-- TAB 1: ARQUEO ACTUAL -->
      <mat-tab label="Arqueo del Día">
        <div class="tab-content">
          <!-- Resumen del Día -->
          <mat-card class="resumen-card" *ngIf="resumenDiario">
            <mat-card-title>Resumen del Día</mat-card-title>
            <mat-card-content>
              <div class="resumen-grid">
                <div class="resumen-item">
                  <span class="resumen-valor text-primary">{{
                    resumenDiario.cantidadPagos
                  }}</span>
                  <span class="resumen-label">Pagos en Efectivo</span>
                </div>
                <div class="resumen-item">
                  <span class="resumen-valor text-success">
                    S/ {{ resumenDiario.totalPagosEfectivo | number: "1.2-2" }}
                  </span>
                  <span class="resumen-label">Total Sistema</span>
                </div>
                <div class="resumen-item">
                  <span
                    class="resumen-valor"
                    [class]="getEstadoClass(resumenDiario.estado)"
                  >
                    {{ resumenDiario.estado }}
                  </span>
                  <span class="resumen-label">Estado</span>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Formulario de Arqueo -->
          <form [formGroup]="formArqueo" class="arqueo-form">
            <mat-card>
              <mat-card-title>
                {{
                  modoEdicion
                    ? "Arqueo Abierto - " + arqueoAbierto?.codArqueo
                    : "Nuevo Arqueo"
                }}
              </mat-card-title>
              <mat-card-content>
                <!-- Datos Generales -->
                <div class="row-flex">
                  <div [style.flex]="setFlex(20, '%')" class="flex-item">
                    <mat-form-field appearance="outline">
                      <mat-label>Fecha</mat-label>
                      <input
                        matInput
                        [matDatepicker]="pickerFecha"
                        readonly="true"
                        formControlName="fecha"
                      />
                      <mat-datepicker-toggle
                        matSuffix
                        [for]="pickerFecha"
                      ></mat-datepicker-toggle>
                      <mat-datepicker #pickerFecha></mat-datepicker>
                    </mat-form-field>
                  </div>

                  <div [style.flex]="setFlex(15, '%')" class="flex-item">
                    <mat-form-field appearance="outline">
                      <mat-label>Turno</mat-label>
                      <mat-select formControlName="turno">
                        <mat-option
                          *ngFor="let turno of turnos"
                          [value]="turno.value"
                        >
                          {{ turno.label }}
                        </mat-option>
                      </mat-select>
                    </mat-form-field>
                  </div>

                  <div [style.flex]="setFlex(20, '%')" class="flex-item">
                    <mat-form-field appearance="outline">
                      <mat-label>Sede</mat-label>
                      <mat-select formControlName="sede">
                        <mat-option
                          *ngFor="let sede of sedes"
                          [value]="sede.value"
                        >
                          {{ sede.label }}
                        </mat-option>
                      </mat-select>
                    </mat-form-field>
                  </div>

                  <div [style.flex]="setFlex(15, '%')" class="flex-item">
                    <mat-form-field appearance="outline">
                      <mat-label>Monto Apertura</mat-label>
                      <input
                        matInput
                        type="number"
                        step="0.01"
                        min="0"
                        formControlName="montoApertura"
                        [readonly]="modoEdicion"
                      />
                      <span matPrefix>S/ </span>
                    </mat-form-field>
                  </div>
                </div>

                <!-- Conteo de Denominaciones -->
                <h6>Conteo de Denominaciones</h6>
                <div
                  class="denominaciones-container"
                  formArrayName="denominaciones"
                >
                  <div class="denominaciones-grid">
                    <!-- Encabezados -->
                    <div class="denominacion-header">Denominación</div>
                    <div class="denominacion-header">Cantidad</div>
                    <div class="denominacion-header">Subtotal</div>

                    <!-- Filas de denominaciones -->
                    <ng-container
                      *ngFor="
                        let denominacion of denominaciones.controls;
                        let i = index
                      "
                      [formGroupName]="i"
                    >
                      <div class="denominacion-cell">
                        <span
                          class="denominacion-tipo"
                          [class.moneda]="
                            denominacion.get('tipo')?.value === 'MONEDA'
                          "
                        >
                          {{ denominacion.get("nombre")?.value }}
                        </span>
                      </div>
                      <div class="denominacion-cell">
                        <mat-form-field
                          appearance="outline"
                          class="cantidad-field"
                        >
                          <input
                            matInput
                            type="number"
                            min="0"
                            formControlName="cantidad"
                            class="text-center"
                          />
                        </mat-form-field>
                      </div>
                      <div class="denominacion-cell">
                        <span class="subtotal-valor">
                          S/
                          {{
                            denominacion.get("subtotal")?.value
                              | number: "1.2-2"
                          }}
                        </span>
                      </div>
                    </ng-container>

                    <!-- Total -->
                    <div class="denominacion-total">Total</div>
                    <div class="denominacion-total"></div>
                    <div class="denominacion-total">
                      <strong
                        >S/
                        {{ getTotalDenominaciones() | number: "1.2-2" }}</strong
                      >
                    </div>
                  </div>
                </div>

                <!-- Resumen del Arqueo -->
                <div class="arqueo-resumen">
                  <div class="resumen-row">
                    <span>Monto Sistema (Efectivo):</span>
                    <span class="text-primary">
                      S/
                      {{ resumenDiario?.totalPagosEfectivo | number: "1.2-2" }}
                    </span>
                  </div>
                  <div class="resumen-row">
                    <span>Monto Físico Contado:</span>
                    <span class="text-info">
                      S/ {{ getTotalDenominaciones() | number: "1.2-2" }}
                    </span>
                  </div>
                  <div class="resumen-row diferencia">
                    <span><strong>Diferencia:</strong></span>
                    <span [class]="getDiferenciaClass(calcularDiferencia())">
                      <strong
                        >S/ {{ calcularDiferencia() | number: "1.2-2" }}</strong
                      >
                    </span>
                  </div>
                </div>

                <!-- Observaciones -->
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Observaciones</mat-label>
                  <textarea
                    matInput
                    rows="3"
                    formControlName="observaciones"
                    placeholder="Observaciones del arqueo..."
                  ></textarea>
                </mat-form-field>
              </mat-card-content>

              <!-- Acciones -->
              <mat-card-actions align="end">
                <button
                  mat-flat-button
                  color="primary"
                  type="button"
                  (click)="abrirArqueo()"
                  *ngIf="!modoEdicion"
                  [disabled]="formArqueo.invalid"
                >
                  <mat-icon>lock_open</mat-icon>
                  Abrir Arqueo
                </button>

                <button
                  mat-flat-button
                  color="accent"
                  type="button"
                  (click)="cerrarArqueo()"
                  *ngIf="modoEdicion"
                >
                  <mat-icon>lock</mat-icon>
                  Cerrar Arqueo
                </button>

                <button
                  mat-button
                  type="button"
                  (click)="nuevoArqueo()"
                  *ngIf="modoEdicion"
                >
                  <mat-icon>refresh</mat-icon>
                  Nuevo Arqueo
                </button>
              </mat-card-actions>
            </mat-card>
          </form>

          <!-- Movimientos del Día -->
          <mat-card class="mt-3">
            <mat-card-title>
              Movimientos de Efectivo del Día
              <button
                mat-icon-button
                color="primary"
                (click)="cargarMovimientosEfectivo()"
                class="refresh-btn"
              >
                <mat-icon>refresh</mat-icon>
              </button>
            </mat-card-title>
            <mat-card-content>
              <div class="table-controls">
                <mat-form-field appearance="outline" class="filter-field">
                  <mat-label>Filtrar movimientos</mat-label>
                  <input
                    matInput
                    (keyup)="filtrarMovimientos($event)"
                    placeholder="Buscar por código, nombre, documento..."
                  />
                  <mat-icon matSuffix>search</mat-icon>
                </mat-form-field>
              </div>

              <div class="table-container">
                <table
                  mat-table
                  [dataSource]="dataSourceMovimientos"
                  matSort
                  class="mat-elevation-z2"
                >
                  <!-- Código Pago -->
                  <ng-container matColumnDef="codPago">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>
                      Cód. Pago
                    </th>
                    <td mat-cell *matCellDef="let row">{{ row.codPago }}</td>
                  </ng-container>

                  <!-- Código Cotización -->
                  <ng-container matColumnDef="codCotizacion">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>
                      Cód. Cotización
                    </th>
                    <td mat-cell *matCellDef="let row">
                      {{ row.codCotizacion }}
                    </td>
                  </ng-container>

                  <!-- Fecha Pago -->
                  <ng-container matColumnDef="fechaPago">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>
                      Fecha
                    </th>
                    <td mat-cell *matCellDef="let row">
                      {{ row.fechaPago | date: "dd/MM/yyyy HH:mm" }}
                    </td>
                  </ng-container>

                  <!-- Nombre Completo -->
                  <ng-container matColumnDef="nombreCompleto">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>
                      Paciente
                    </th>
                    <td mat-cell *matCellDef="let row">
                      {{ row.nombreCompleto }}
                    </td>
                  </ng-container>

                  <!-- Documento -->
                  <ng-container matColumnDef="documento">
                    <th mat-header-cell *matHeaderCellDef>Documento</th>
                    <td mat-cell *matCellDef="let row">
                      {{ row.tipoDoc }} {{ row.nroDoc }}
                    </td>
                  </ng-container>

                  <!-- Monto Efectivo -->
                  <ng-container matColumnDef="montoEfectivo">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>
                      Monto
                    </th>
                    <td mat-cell *matCellDef="let row">
                      <span class="text-success">
                        S/ {{ row.montoEfectivo | number: "1.2-2" }}
                      </span>
                    </td>
                  </ng-container>

                  <!-- Usuario -->
                  <ng-container matColumnDef="usuario">
                    <th mat-header-cell *matHeaderCellDef>Usuario</th>
                    <td mat-cell *matCellDef="let row">{{ row.usuario }}</td>
                  </ng-container>

                  <tr
                    mat-header-row
                    *matHeaderRowDef="columnasMovimientos"
                  ></tr>
                  <tr
                    mat-row
                    *matRowDef="let row; columns: columnasMovimientos"
                  ></tr>
                </table>

                <mat-paginator
                  #paginatorMovimientos
                  [pageSizeOptions]="[10, 25, 50]"
                  [pageSize]="25"
                  showFirstLastButtons
                ></mat-paginator>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- TAB 2: HISTORIAL DE ARQUEOS -->
      <mat-tab label="Historial de Arqueos">
        <div class="tab-content">
          <!-- Filtros de Búsqueda -->
          <form [formGroup]="formBusqueda" class="busqueda-form">
            <div class="row-flex">
              <div [style.flex]="setFlex(15, '%')" class="flex-item">
                <mat-form-field appearance="outline">
                  <mat-label>Fecha Inicio</mat-label>
                  <input
                    matInput
                    [matDatepicker]="pickerInicio"
                    readonly="true"
                    formControlName="fechaInicio"
                  />
                  <mat-datepicker-toggle
                    matSuffix
                    [for]="pickerInicio"
                  ></mat-datepicker-toggle>
                  <mat-datepicker #pickerInicio></mat-datepicker>
                </mat-form-field>
              </div>

              <div [style.flex]="setFlex(15, '%')" class="flex-item">
                <mat-form-field appearance="outline">
                  <mat-label>Fecha Fin</mat-label>
                  <input
                    matInput
                    [matDatepicker]="pickerFin"
                    readonly="true"
                    formControlName="fechaFin"
                  />
                  <mat-datepicker-toggle
                    matSuffix
                    [for]="pickerFin"
                  ></mat-datepicker-toggle>
                  <mat-datepicker #pickerFin></mat-datepicker>
                </mat-form-field>
              </div>

              <div [style.flex]="setFlex(15, '%')" class="flex-item">
                <mat-form-field appearance="outline">
                  <mat-label>Sede</mat-label>
                  <mat-select formControlName="sede">
                    <mat-option value="">Todas</mat-option>
                    <mat-option *ngFor="let sede of sedes" [value]="sede.value">
                      {{ sede.label }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <div [style.flex]="setFlex(10, '%')" class="flex-item">
                <button
                  mat-flat-button
                  type="button"
                  (click)="buscarArqueos()"
                  class="buscar-btn"
                >
                  <mat-icon>search</mat-icon>
                  Buscar
                </button>
              </div>

              <div [style.flex]="setFlex(20, '%')" class="flex-item">
                <mat-form-field appearance="outline">
                  <mat-label>Filtrar resultados</mat-label>
                  <input
                    matInput
                    (keyup)="filtrarArqueos($event)"
                    placeholder="Filtrar por código, usuario..."
                  />
                  <mat-icon matSuffix>search</mat-icon>
                </mat-form-field>
              </div>

              <div [style.flex]="setFlex(10, '%')" class="flex-item">
                <button
                  mat-raised-button
                  color="accent"
                  type="button"
                  (click)="exportarHistorialArqueos()"
                  [disabled]="dataSourceArqueos.data.length === 0"
                  class="export-btn"
                >
                  <mat-icon>file_download</mat-icon>
                  Exportar
                </button>
              </div>
            </div>
          </form>

          <!-- Tabla de Arqueos -->
          <div class="table-container">
            <table
              mat-table
              [dataSource]="dataSourceArqueos"
              matSort
              class="mat-elevation-z4"
            >
              <!-- Código Arqueo -->
              <ng-container matColumnDef="codArqueo">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  Código
                </th>
                <td mat-cell *matCellDef="let row">{{ row.codArqueo }}</td>
              </ng-container>

              <!-- Fecha -->
              <ng-container matColumnDef="fecha">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha</th>
                <td mat-cell *matCellDef="let row">
                  {{ row.fecha | date: "dd/MM/yyyy" }}
                </td>
              </ng-container>

              <!-- Turno -->
              <ng-container matColumnDef="turno">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Turno</th>
                <td mat-cell *matCellDef="let row">{{ row.turno }}</td>
              </ng-container>

              <!-- Usuario -->
              <ng-container matColumnDef="usuario">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  Usuario
                </th>
                <td mat-cell *matCellDef="let row">{{ row.usuarioArqueo }}</td>
              </ng-container>

              <!-- Monto Sistema -->
              <ng-container matColumnDef="montoSistema">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  Monto Sistema
                </th>
                <td mat-cell *matCellDef="let row">
                  <span class="text-primary">
                    S/ {{ row.montoSistema | number: "1.2-2" }}
                  </span>
                </td>
              </ng-container>

              <!-- Monto Cierre -->
              <ng-container matColumnDef="montoCierre">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  Monto Físico
                </th>
                <td mat-cell *matCellDef="let row">
                  <span class="text-info">
                    S/ {{ row.montoCierre | number: "1.2-2" }}
                  </span>
                </td>
              </ng-container>

              <!-- Diferencia -->
              <ng-container matColumnDef="diferencia">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  Diferencia
                </th>
                <td mat-cell *matCellDef="let row">
                  <span [class]="getDiferenciaClass(row.diferencia)">
                    S/ {{ row.diferencia | number: "1.2-2" }}
                  </span>
                </td>
              </ng-container>

              <!-- Estado -->
              <ng-container matColumnDef="estado">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  Estado
                </th>
                <td mat-cell *matCellDef="let row">
                  <span [class]="getEstadoClass(row.estado)">
                    {{ row.estado }}
                  </span>
                </td>
              </ng-container>

              <!-- Acciones -->
              <ng-container matColumnDef="acciones">
                <th mat-header-cell *matHeaderCellDef>Acciones</th>
                <td mat-cell *matCellDef="let row">
                  <button
                    mat-icon-button
                    color="primary"
                    [title]="'Ver detalle'"
                    (click)="verDetalleArqueo(row)"
                  >
                    <mat-icon>visibility</mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    color="accent"
                    [title]="'Exportar'"
                    (click)="exportarArqueo(row)"
                  >
                    <mat-icon>file_download</mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="columnasArqueos"></tr>
              <tr mat-row *matRowDef="let row; columns: columnasArqueos"></tr>
            </table>

            <mat-paginator
              #paginatorArqueos
              [pageSizeOptions]="[10, 25, 50, 100]"
              [pageSize]="25"
              showFirstLastButtons
            ></mat-paginator>
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>
</div>
